"use strict";var _={},sa={para:{name:"sensors",server_url:"",send_timeout:1e3,show_log:!0,launched:!1,allow_amend_share_path:!0,max_string_length:300,datasend_timeout:3e3,source_channel:[],autoTrack:{appLaunch:!0,appShow:!0,appHide:!0,pageShow:!0,pageShare:!0,mpClick:!1,mpFavorite:!0},autotrack_exclude_page:{pageShow:[]},is_persistent_save:{share:!1,utm:!1},preset_properties:{},batch_send:!0}},mpHook={data:1,onLoad:1,onShow:1,onReady:1,onPullDownRefresh:1,onReachBottom:1,onShareAppMessage:1,onPageScroll:1,onResize:1,onTabItemTap:1,onHide:1,onUnload:1},logger="object"==typeof logger?logger:{};logger.info=function(){if(sa.para.show_log&&"object"==typeof console&&console.log)try{if(3===arguments.length)return console.log(arguments[0],arguments[1],arguments[2]);if(2===arguments.length)return console.log(arguments[0],arguments[1]);if(1===arguments.length)return console.log(arguments[0])}catch(e){console.log(arguments[0])}},sa.setPara=function(e){sa.para=_.extend2Lev(sa.para,e);var t=[];if(_.isArray(sa.para.source_channel))for(var a=sa.para.source_channel.length,r=0;r<a;r++)~" utm_source utm_medium utm_campaign utm_content utm_term sa_utm ".indexOf(" "+sa.para.source_channel[r]+" ")||t.push(sa.para.source_channel[r]);sa.para.source_channel=t,_.isObject(sa.para.register)&&_.extend(_.info.properties,sa.para.register),sa.para.openid_url||(sa.para.openid_url=sa.para.server_url.replace(/([^\/])\/(sa)(\.gif){0,1}/,"$1/mp_login")),"number"!=typeof sa.para.send_timeout&&(sa.para.send_timeout=1e3);var s={send_timeout:6e3,max_length:6};e&&e.datasend_timeout||sa.para.batch_send&&(sa.para.datasend_timeout=1e4),!0===sa.para.batch_send?sa.para.batch_send=_.extend({},s):_.isObject(sa.para.batch_send)&&(sa.para.batch_send=_.extend({},s,sa.para.batch_send));s={share:!1,utm:!1};!0===sa.para.is_persistent_save?(sa.para.is_persistent_save=_.extend({},s),sa.para.is_persistent_save.utm=!0):_.isObject(sa.para.is_persistent_save)&&(sa.para.is_persistent_save=_.extend({},s,sa.para.is_persistent_save)),sa.para.server_url?sa.para.preset_properties=_.isObject(sa.para.preset_properties)?sa.para.preset_properties:{}:logger.info("请使用 setPara() 方法设置 server_url 数据接收地址,详情可查看https://www.sensorsdata.cn/manual/mp_sdk_new.html#112-%E5%BC%95%E5%85%A5%E5%B9%B6%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0")},sa.getServerUrl=function(){return sa.para.server_url},sa.status={};var ArrayProto=Array.prototype,ObjProto=Object.prototype,slice=ArrayProto.slice,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty,LIB_VERSION="1.14.11",LIB_NAME="MiniProgram",source_channel_standard="utm_source utm_medium utm_campaign utm_content utm_term",latest_source_channel=["$latest_utm_source","$latest_utm_medium","$latest_utm_campaign","$latest_utm_content","$latest_utm_term","$latest_sa_utm"],latest_share_info=["$latest_share_distinct_id","$latest_share_url_path","$latest_share_depth","$latest_share_method"],sa_referrer="直接打开",mpshow_time=null,query_share_depth=0,share_distinct_id="",share_method="",current_scene="",is_first_launch=!(sa.status.referrer="直接打开"),wxSDKVersion="";sa.lib_version=LIB_VERSION;var globalTitle={};!function(){var i=ArrayProto.forEach,r=ArrayProto.indexOf,e=Array.isArray,o={},s=_.each=function(e,t,a){if(null==e)return!1;if(i&&e.forEach===i)e.forEach(t,a);else if(e.length===+e.length){for(var r=0,s=e.length;r<s;r++)if(r in e&&t.call(a,e[r],r,e)===o)return!1}else for(var n in e)if(hasOwnProperty.call(e,n)&&t.call(a,e[n],n,e)===o)return!1};_.logger=logger,_.extend=function(a){return s(slice.call(arguments,1),function(e){for(var t in e)void 0!==e[t]&&(a[t]=e[t])}),a},_.extend2Lev=function(a){return s(slice.call(arguments,1),function(e){for(var t in e)null!=e[t]&&(_.isObject(e[t])&&_.isObject(a[t])?_.extend(a[t],e[t]):a[t]=e[t])}),a},_.coverExtend=function(a){return s(slice.call(arguments,1),function(e){for(var t in e)void 0!==e[t]&&void 0===a[t]&&(a[t]=e[t])}),a},_.isArray=e||function(e){return"[object Array]"===toString.call(e)},_.isFunction=function(e){try{return/^\s*\bfunction\b/.test(e)}catch(e){return!1}},_.isArguments=function(e){return!(!e||!hasOwnProperty.call(e,"callee"))},_.toArray=function(e){return e?e.toArray?e.toArray():_.isArray(e)||_.isArguments(e)?slice.call(e):_.values(e):[]},_.values=function(e){var t=[];return null==e||s(e,function(e){t[t.length]=e}),t},_.include=function(e,t){var a=!1;return null==e?a:r&&e.indexOf===r?!!~e.indexOf(t):(s(e,function(e){if(a=a||e===t)return o}),a)}}(),_.trim=function(e){return e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},_.isObject=function(e){return null!=e&&"[object Object]"==toString.call(e)},_.isEmptyObject=function(e){if(_.isObject(e)){for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0}return!1},_.isUndefined=function(e){return void 0===e},_.isString=function(e){return"[object String]"==toString.call(e)},_.isDate=function(e){return"[object Date]"==toString.call(e)},_.isBoolean=function(e){return"[object Boolean]"==toString.call(e)},_.isNumber=function(e){return"[object Number]"==toString.call(e)&&/[\d\.]+/.test(""+e)},_.isJSONString=function(e){try{JSON.parse(e)}catch(e){return!1}return!0},_.decodeURIComponent=function(t){var a="";try{a=decodeURIComponent(t)}catch(e){a=t}return a},_.encodeDates=function(a){return _.each(a,function(e,t){_.isDate(e)?a[t]=_.formatDate(e):_.isObject(e)&&(a[t]=_.encodeDates(e))}),a},_.formatDate=function(e){function t(e){return e<10?"0"+e:e}return e.getFullYear()+"-"+t(1+e.getMonth())+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+"."+t(e.getMilliseconds())},_.searchObjDate=function(a){_.isObject(a)&&_.each(a,function(e,t){_.isObject(e)?_.searchObjDate(a[t]):_.isDate(e)&&(a[t]=_.formatDate(e))})},_.formatString=function(e){return sa.para.max_string_length<e.length?(logger.info("字符串长度超过限制，已经做截取--"+e),e.slice(0,sa.para.max_string_length)):e},_.searchObjString=function(a){_.isObject(a)&&_.each(a,function(e,t){_.isObject(e)?_.searchObjString(a[t]):_.isString(e)&&(a[t]=_.formatString(e))})},_.parseSuperProperties=function(a){_.isObject(a)&&(_.each(a,function(e,t){if(_.isFunction(e))try{a[t]=e(),_.isFunction(a[t])&&(logger.info("您的属性- "+t+" 格式不满足要求，我们已经将其删除"),delete a[t])}catch(e){delete a[t],logger.info("您的属性- "+t+" 抛出了异常，我们已经将其删除")}}),_.strip_sa_properties(a))},_.unique=function(e){for(var t,a=[],r={},s=0;s<e.length;s++)(t=e[s])in r||(r[t]=!0,a.push(t));return a},_.strip_sa_properties=function(r){return _.isObject(r)&&_.each(r,function(t,e){var a;_.isArray(t)&&(a=[],_.each(t,function(e){_.isString(e)?a.push(e):logger.info("您的数据-",t,"的数组里的值必须是字符串,已经将其删除")}),0!==a.length?r[e]=a:(delete r[e],logger.info("已经删除空的数组"))),_.isString(t)||_.isNumber(t)||_.isDate(t)||_.isBoolean(t)||_.isArray(t)||(logger.info("您的数据-",t,"-格式不满足要求，我们已经将其删除"),delete r[e])}),r},_.strip_empty_properties=function(e){var a={};return _.each(e,function(e,t){null!=e&&(a[t]=e)}),a},_.utf8Encode=function(e){for(var t,a="",r=t=0,s=(e=(e+"").replace(/\r\n/g,"\n").replace(/\r/g,"\n")).length,n=0;n<s;n++){var i=e.charCodeAt(n),o=null;i<128?t++:o=127<i&&i<2048?String.fromCharCode(i>>6|192,63&i|128):String.fromCharCode(i>>12|224,i>>6&63|128,63&i|128),null!==o&&(r<t&&(a+=e.substring(r,t)),a+=o,r=t=n+1)}return r<t&&(a+=e.substring(r,e.length)),a},_.base64Encode=function(e){var t,a,r,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",n=0,i=0,o="",c=[];if(!e)return e;for(e=_.utf8Encode(e);t=e.charCodeAt(n++),a=e.charCodeAt(n++),r=e.charCodeAt(n++),c[i++]=(s[0|(r=t<<16|a<<8|r)>>18&63]||"")+(s[0|r>>12&63]||"")+(s[0|r>>6&63]||"")+(s[0|63&r]||""),n<e.length;);switch(o=c.join(""),e.length%3){case 1:o=o.slice(0,-2)+"==";break;case 2:o=o.slice(0,-1)+"="}return o},_.rot13obfs=function(e,t){t="number"==typeof t?t:13;for(var a=(e=""+e).split(""),r=0,s=a.length;r<s;r++)a[r].charCodeAt(0)<126&&(a[r]=String.fromCharCode((a[r].charCodeAt(0)+t)%126));return a.join("")},_.rot13defs=function(e){e=""+e;return _.rot13obfs(e,113)},_.getCurrentPath=function(){var e="未取到";try{var t=getCurrentPages(),e=t[t.length-1].route}catch(e){logger.info(e)}return e},_.getIsFirstDay=function(){return"object"==typeof sa.store._state&&"number"==typeof sa.store._state.first_visit_day_time&&sa.store._state.first_visit_day_time>(new Date).getTime()},_.getCurrentUrl=function(e){var t=_.getCurrentPath(),a="";return _.isObject(e)&&e.sensors_mp_encode_url_query&&(a=e.sensors_mp_encode_url_query),t?a?t+"?"+a:t:"未取到"},_.getPath=function(e){return e="string"==typeof e?e.replace(/^\//,""):"取值异常"},_.getMethods=function(e){var t,a=[];for(t in e)"function"!=typeof e[t]||mpHook[t]||a.push(t);return a},sa.initialState={queue:[],isComplete:!(_.isClick=function(e){return!!{tap:1,longpress:1,longtap:1}[e]}),systemIsComplete:!1,storeIsComplete:!1,checkIsComplete:function(){this.systemIsComplete&&this.storeIsComplete&&(this.isComplete=!0,0<this.queue.length&&(_.each(this.queue,function(e){sa[e[0]].apply(sa,slice.call(e[1]))}),this.queue=[]))}},_.getCustomUtmFromQuery=function(e,t,a,r){if(!_.isObject(e))return{};var s={};if(e.sa_utm)for(var n in e)"sa_utm"!==n?_.include(sa.para.source_channel,n)&&(s[a+n]=e[n]):s[r+n]=e[n];else for(var n in e)~(" "+source_channel_standard+" ").indexOf(" "+n+" ")?s[t+n]=e[n]:_.include(sa.para.source_channel,n)&&(s[a+n]=e[n]);return s},_.getObjFromQuery=function(e){var t,e=e.split("?"),a={};return e&&e[1]?(_.each(e[1].split("&"),function(e){(t=e.split("="))[0]&&t[1]&&(a[t[0]]=t[1])}),a):{}},_.setStorageSync=function(e,t){function a(){wx.setStorageSync(e,t)}try{a()}catch(e){logger.info("set Storage fail --",e);try{a()}catch(e){logger.info("set Storage fail again --",e)}}},_.getStorageSync=function(t){var a="";try{a=wx.getStorageSync(t)}catch(e){try{a=wx.getStorageSync(t)}catch(e){logger.info("getStorage fail")}}return a},_.getMPScene=function(e){return"number"==typeof e||"string"==typeof e&&""!==e?e="wx-"+e:"未取到值"},_.setShareInfo=function(e,t){var a={},r={},s=sa.store.getDistinctId(),n=sa.store.getFirstId();if(!(e&&_.isObject(e.query)&&e.query.sampshare))return{};if(a=_.decodeURIComponent(e.query.sampshare),!_.isJSONString(a))return{};var i=(a=JSON.parse(a)).d,o=a.p,e=a.i,a=a.m;"string"==typeof e?(share_distinct_id=t.$share_distinct_id=e,r.$latest_share_distinct_id=e):t.$share_distinct_id="取值异常","number"==typeof i?!share_distinct_id||share_distinct_id!==s&&share_distinct_id!==n?!share_distinct_id||share_distinct_id===s&&share_distinct_id===n?t.$share_depth="-1":(t.$share_depth=i+1,query_share_depth=i+1,r.$latest_share_depth=i+1):(query_share_depth=t.$share_depth=i,r.$latest_share_depth=i):t.$share_depth="-1","string"==typeof o?r.$latest_share_url_path=t.$share_url_path=o:t.$share_url_path="取值异常","string"==typeof a?r.$latest_share_method=t.$share_method=a:t.$share_method="取值异常",_.setLatestShare(r)},_.getShareInfo=function(){return JSON.stringify({i:sa.store.getDistinctId()||"取值异常",p:_.getCurrentPath(),d:query_share_depth,m:share_method})},_.detectOptionQuery=function(e){if(!e||!_.isObject(e.query))return{};var t,a,r,s={};return s.query=_.extend({},e.query),"string"==typeof s.query.scene&&(t=s.query,a=["utm_source","utm_content","utm_medium","utm_campaign","utm_term","sa_utm"].concat(sa.para.source_channel),r=RegExp("("+a.join("|")+")%3D","i"),1===(a=Object.keys(t)).length&&"scene"===a[0]&&r.test(t.scene))&&(s.scene=s.query.scene,delete s.query.scene),e.query.q&&e.query.scancode_time&&"101"===(""+e.scene).slice(0,3)&&(s.q=""+s.query.q,delete s.query.q,delete s.query.scancode_time),s},_.getMixedQuery=function(e){var t,a=_.detectOptionQuery(e),r=a.scene,e=a.q,s=a.query;for(t in s)s[t]=_.decodeURIComponent(s[t]);return r&&(r=~(r=_.decodeURIComponent(r)).indexOf("?")?"?"+r.replace(/\?/g,""):"?"+r,_.extend(s,_.getObjFromQuery(r))),e&&_.extend(s,_.getObjFromQuery(_.decodeURIComponent(e))),s},_.setUtm=function(e,t){var a={},r=_.getMixedQuery(e),e=_.getCustomUtmFromQuery(r,"$","_","$"),r=_.getCustomUtmFromQuery(r,"$latest_","_latest_","$latest_");return a.pre1=e,a.pre2=r,_.extend(t,e),a},_.setSfSource=function(e,t){!_.isEmptyObject(e.query)&&e.query._sfs&&(t.$sf_source=e.query._sfs,sa.registerApp({$latest_sf_source:t.$sf_source}))},_.setPageSfSource=function(e){try{var t,a=getCurrentPages(),r=JSON.parse(JSON.stringify(a[a.length-1].options));for(t in r)r[t]=_.decodeURIComponent(r[t]);!_.isEmptyObject(r)&&r._sfs&&(e.$sf_source=r._sfs)}catch(e){logger.info(e)}};try{var oldSetNavigationBarTitle=wx.setNavigationBarTitle;Object.defineProperty(wx,"setNavigationBarTitle",{get:function(){return function(e){var t=getCurrentPages(),t=t[t.length-1].route||"";e=_.isObject(e)?e:{},globalTitle[t]=e.title,oldSetNavigationBarTitle.call(this,e)}}})}catch(e){logger.info(e)}function mp_proxy(e,t,a){var r,s=sa.autoTrackCustom[a];e[t]?(r=e[t],e[t]=function(){"onLaunch"===t&&(this[sa.para.name]=sa),!sa.para.autoTrackIsFirst||_.isObject(sa.para.autoTrackIsFirst)&&!sa.para.autoTrackIsFirst[a]?(r.apply(this,arguments),s.apply(this,arguments)):(!0===sa.para.autoTrackIsFirst||_.isObject(sa.para.autoTrackIsFirst)&&sa.para.autoTrackIsFirst[a])&&(s.apply(this,arguments),r.apply(this,arguments))}):e[t]=function(){"onLaunch"===t&&(this[sa.para.name]=sa),s.apply(this,arguments)}}function click_proxy(e,t){var n=e[t];e[t]=function(){var e=n.apply(this,arguments),t={},a="";if(_.isObject(arguments[0])){var r=arguments[0].currentTarget||{},s=arguments[0].target||{};if(_.isObject(sa.para.framework)&&_.isObject(sa.para.framework.taro)&&!sa.para.framework.taro.createApp&&s.id&&r.id&&s.id!==r.id)return e;s=r.dataset||{},a=arguments[0].type;t.$element_id=r.id,t.$element_type=s.type,t.$element_content=s.content,t.$element_name=s.name,_.isObject(arguments[0].event_prop)&&(t=_.extend(t,arguments[0].event_prop))}return a&&_.isClick(a)&&(t.$url_path=_.getCurrentPath(),sa.track("$MPClick",t)),e}}function tabProxy(e){var a=e.onTabItemTap;e.onTabItemTap=function(e){a&&a.apply(this,arguments);var t={};e&&(t.$element_content=e.text),t.$element_type="tabBar",t.$url_path=_.getCurrentPath(),sa.track("$MPClick",t)}}_.getPageTitle=function(a){if("未取到"===a||!a)return!1;var e,t,r,s,n="";try{__wxConfig&&(t=(e=__wxConfig).page[a]||e.page[a+".html"],r={},s={},e.global&&e.global.window&&e.global.window.navigationBarTitleText&&(r.titleVal=e.global.window.navigationBarTitleText),t&&t.window&&t.window.navigationBarTitleText&&(s.titleVal=t.window.navigationBarTitleText),_.each(globalTitle,function(e,t){if(t===a)return n=e}),0===n.length&&(n=_.extend(r,s).titleVal))}catch(e){logger.info(e)}return n},_.wxrequest=function(e){var t;_.compareSDKVersion(wxSDKVersion,"2.10.0")<0?(t=wx.request(e),setTimeout(function(){_.isObject(t)&&_.isFunction(t.abort)&&t.abort()},sa.para.datasend_timeout)):(e.timeout=sa.para.datasend_timeout,wx.request(e))},_.getAppId=function(){var e;if(wx.getAccountInfoSync&&(e=wx.getAccountInfoSync()),_.isObject(e)&&_.isObject(e.miniProgram))return e.miniProgram.appId},_.validId=function(e){return("string"==typeof e||"number"==typeof e)&&""!==e&&("number"!=typeof e||/^\d+$/.test(e=""+e))?e:(logger.info("输入 ID 类型错误"),!1)},_.compareSDKVersion=function(e,t){e=e.split("."),t=t.split(".");for(var a=Math.max(e.length,t.length);e.length<a;)e.push("0");for(;t.length<a;)t.push("0");for(var r=0;r<a;r++){var s=parseInt(e[r]),n=parseInt(t[r]);if(n<s)return 1;if(s<n)return-1}return 0},_.setUpperCase=function(e){return _.isString(e)?e.toLocaleUpperCase():e},_.info={currentProps:{},properties:{$lib:LIB_NAME,$lib_version:""+LIB_VERSION},getSystem:function(){var r=this.properties;function e(){wx.getSystemInfo({success:function(e){var t,a;r.$brand=_.setUpperCase(e.brand),r.$manufacturer=e.brand,r.$model=e.model,r.$screen_width=+(""+e.screenWidth),r.$screen_height=+(""+e.screenHeight),r.$os="ios"==(a=(t=e.platform).toLowerCase())?"iOS":"android"==a?"Android":t,r.$os_version=~e.system.indexOf(" ")?e.system.split(" ")[1]:e.system,wxSDKVersion=e.SDKVersion},complete:function(){var e=(new Date).getTimezoneOffset(),t=_.getAppId();_.isNumber(e)&&(r.$timezone_offset=e),t&&(r.$app_id=t),sa.initialState.systemIsComplete=!0,sa.initialState.checkIsComplete()}})}wx.getNetworkType({success:function(e){r.$network_type=_.setUpperCase(e.networkType)},complete:e})}},(sa._=_).eventEmitter=function(){this.sub=[]},_.eventEmitter.prototype={add:function(e){this.sub.push(e)},emit:function(t,a){this.sub.forEach(function(e){e.on(t,a)})}},_.eventSub=function(e){sa.events.add(this),this._events=[],this.handle=e,this.ready=!1},_.eventSub.prototype={on:function(e,t){if(this.ready){if(_.isFunction(this.handle))try{this.handle(e,t)}catch(e){logger.info(e)}}else this._events.push({event:e,data:t})},isReady:function(){var t=this;t.ready=!0,t._events.forEach(function(e){if(_.isFunction(t.handle))try{t.handle(e.event,e.data)}catch(e){logger.info(e)}})}},sa.eventSub=_.eventSub,sa.events=new _.eventEmitter,sa.usePlugin=function(e,t){"function"==typeof e.init&&e.init(sa,t)},sa.prepareData=function(e,t){if(current_scene&&1154===current_scene)return!1;var a={distinct_id:this.store.getDistinctId(),lib:{$lib:LIB_NAME,$lib_method:"code",$lib_version:""+LIB_VERSION},properties:{}};_.extend(a,this.store.getUnionId(),e),_.isObject(e.properties)&&!_.isEmptyObject(e.properties)&&_.extend(a.properties,e.properties),e.type&&"profile"===e.type.slice(0,7)||(a._track_id=+(""+((""+Math.random()).slice(2,5)+(""+Math.random()).slice(2,4)+(""+Date.now()).slice(-4))),a.properties=_.extend({},_.info.properties,sa.store.getProps(),_.info.currentProps,a.properties),a.properties.$is_first_day=_.getIsFirstDay()),a.properties.$time&&_.isDate(a.properties.$time)?(a.time=+a.properties.$time,delete a.properties.$time):a.time=+new Date,_.parseSuperProperties(a.properties),_.searchObjDate(a),_.searchObjString(a),logger.info(a),sa.events.emit("send",a),sa.sendStrategy.send(a)},sa.store={storageInfo:null,getUUID:function(){return Date.now()+"-"+Math.floor(1e7*Math.random())+"-"+Math.random().toString(16).replace(".","")+"-"+(""+31242*Math.random()).replace(".","").slice(0,8)},getStorage:function(){return this.storageInfo||(this.storageInfo=sa._.getStorageSync("sensorsdata2015_wechat")||"",this.storageInfo)},_state:{},mem:{mdata:[],getLength:function(){return this.mdata.length},add:function(e){this.mdata.push(e)},clear:function(e){this.mdata.splice(0,e)}},toState:function(e){var t=null;_.isJSONString(e)?(t=JSON.parse(e)).distinct_id?this._state=t:this.set("distinct_id",this.getUUID()):_.isObject(e)&&(t=e).distinct_id?this._state=t:this.set("distinct_id",this.getUUID())},getFirstId:function(){return this._state._first_id||this._state.first_id},getDistinctId:function(){return this._state._distinct_id||this._state.distinct_id},getUnionId:function(){var e={},t=this._state._first_id||this._state.first_id,a=this._state._distinct_id||this._state.distinct_id;return t&&a?(e.login_id=a,e.anonymous_id=t):e.anonymous_id=a,e},getProps:function(){return this._state.props||{}},setProps:function(e,t){var a=this._state.props||{};t?this.set("props",e):(_.extend(a,e),this.set("props",a))},set:function(e,t){var a,r={};for(a in"string"==typeof e?r[e]=t:"object"==typeof e&&(r=e),this._state=this._state||{},r)this._state[a]=r[a],"first_id"===a?delete this._state._first_id:"distinct_id"===a&&(delete this._state._distinct_id,sa.events.emit("changeDistinctId"));this.save()},change:function(e,t){this._state["_"+e]=t},encryptStorage:function(){var e=this.getStorage(),t="data:enc;";_.isObject(e)?e=t+_.rot13obfs(JSON.stringify(e)):_.isString(e)&&(~e.indexOf(t)||(e=t+_.rot13obfs(e))),sa._.setStorageSync("sensorsdata2015_wechat",e)},save:function(){var e=JSON.parse(JSON.stringify(this._state));delete e._first_id,delete e._distinct_id,sa.para.encrypt_storage&&(e="data:enc;"+_.rot13obfs(JSON.stringify(e))),sa._.setStorageSync("sensorsdata2015_wechat",e)},init:function(){var e=this.getStorage(),t="data:enc;";e?(_.isString(e)&&~e.indexOf(t)&&(e=e.substring(9),e=JSON.parse(_.rot13defs(e))),this.toState(e)):(is_first_launch=!0,e=(t=new Date).getTime(),t.setHours(23),t.setMinutes(59),t.setSeconds(60),sa.setOnceProfile({$first_visit_time:new Date}),this.set({distinct_id:this.getUUID(),first_visit_time:e,first_visit_day_time:t.getTime()}))}},sa.setProfile=function(e,t){sa.prepareData({type:"profile_set",properties:e},t)},sa.setOnceProfile=function(e,t){sa.prepareData({type:"profile_set_once",properties:e},t)},sa.appendProfile=function(a,e){if(!_.isObject(a))return!1;_.each(a,function(e,t){_.isString(e)?a[t]=[e]:_.isArray(e)||(delete a[t],logger.info("appendProfile属性的值必须是字符串或者数组"))}),sa.prepareData({type:"profile_append",properties:a},e)},sa.incrementProfile=function(e,t){if(!_.isObject(e))return!1;var a=e;_.isString(e)&&((e={})[a]=1),sa.prepareData({type:"profile_increment",properties:e},t)},sa.track=function(e,t,a){this.prepareData({type:"track",event:e,properties:t},a)},sa.identify=function(e,t){var a;(e=_.validId(e))&&(a=sa.store.getFirstId(),!0===t?sa.store.set(a?"first_id":"distinct_id",e):sa.store.change(a?"first_id":"distinct_id",e))},sa.trackSignup=function(e,t,a,r){var s=sa.store.getFirstId()||sa.store.getDistinctId();sa.store.set("distinct_id",e),sa.prepareData({original_id:s,distinct_id:e,type:"track_signup",event:t,properties:a},r)},sa.registerApp=function(e){_.isObject(e)&&!_.isEmptyObject(e)&&(_.info.currentProps=_.extend(_.info.currentProps,e))},sa.register=function(e){_.isObject(e)&&!_.isEmptyObject(e)&&sa.store.setProps(e)},sa.clearAllRegister=function(){sa.store.setProps({},!0)},sa.clearAllProps=function(a){var e=sa.store.getProps(),r={};_.isArray(a)&&(_.each(e,function(e,t){_.include(a,t)||(r[t]=e)}),sa.store.setProps(r,!0))},sa.clearAppRegister=function(a){_.isArray(a)&&_.each(_.info.currentProps,function(e,t){_.include(a,t)&&delete _.info.currentProps[t]})},_.setLatestChannel=function(e){_.isEmptyObject(e)||(!function(e,t){var a,r=!1;for(a in t)e[t[a]]&&(r=!0);return r}(e,latest_source_channel)||(sa.clearAppRegister(latest_source_channel),sa.clearAllProps(latest_source_channel)),sa.para.is_persistent_save.utm?sa.register(e):sa.registerApp(e))},_.setLatestShare=function(e){(e.$latest_share_depth||e.$latest_share_distinct_id||e.$latest_share_url_path||e.$latest_share_method)&&(sa.clearAppRegister(latest_share_info),sa.clearAllProps(latest_share_info),sa.para.is_persistent_save.share?sa.register(e):sa.registerApp(e))},sa.login=function(e){var t,a;(e=_.validId(e))&&(t=sa.store.getFirstId(),e!==(a=sa.store.getDistinctId())&&(t||sa.store.set("first_id",a),sa.trackSignup(e,"$SignUp")))},sa.getAnonymousID=function(){if(!_.isEmptyObject(sa.store._state))return sa.store._state._first_id||sa.store._state.first_id||sa.store._state._distinct_id||sa.store._state.distinct_id;logger.info("请先初始化SDK")},sa.logout=function(e){var t=sa.store.getFirstId();t?(sa.store.set("first_id",""),sa.store.set("distinct_id",!0===e?sa.store.getUUID():t)):logger.info("没有first_id，logout失败")},sa.getLocation=function(){wx.getSetting({success:function(e){if(!e.authSetting["scope.userLocation"])return!1;wx.getLocation({type:sa.para.preset_properties.location.type,success:function(e){sa.registerApp({$latitude:1e6*e.latitude,$longitude:1e6*e.longitude,$geo_coordinate_system:_.setUpperCase(sa.para.preset_properties.location.type)})},fail:function(e){console.log("获取位置失败",e)}})}})},sa.openid={getRequest:function(t){wx.login({success:function(e){e.code&&sa.para.appid&&sa.para.openid_url?_.wxrequest({url:sa.para.openid_url+"&code="+e.code+"&appid="+sa.para.appid,method:"GET",complete:function(e){_.isObject(e)&&_.isObject(e.data)&&e.data.openid?t(e.data.openid):t()}}):t()}})},getWXStorage:function(){var e=sa.store.getStorage();if(e&&_.isObject(e))return e.openid},getOpenid:function(e){if(!sa.para.appid)return e(),!1;var t=this.getWXStorage();t?e(t):this.getRequest(e)}},sa.initial=function(){this._.info.getSystem(),this.store.init()},sa.init=function(e){if(!0===this.hasInit)return!1;this.hasInit=!0,sa.setPara(e),sa.para.encrypt_storage&&this.store.encryptStorage(),sa.para.batch_send&&(wx.getStorage({key:"sensors_mp_prepare_data",complete:function(e){e=e.data&&_.isArray(e.data)?e.data:[];sa.store.mem.mdata=e.concat(sa.store.mem.mdata),sa.sendStrategy.syncStorage=!0}}),sa.sendStrategy.batchInterval()),sa.initialState.storeIsComplete=!0,sa.initialState.checkIsComplete()},sa.getPresetProperties=function(){if(_.info&&_.info.properties&&_.info.properties.$lib){var a={};_.each(_.info.currentProps,function(e,t){t.indexOf("$")||(a[t]=e)});var e=_.extend(a,{$url_path:_.getCurrentPath(),$is_first_day:_.getIsFirstDay()},_.info.properties,sa.store.getProps());return delete e.$lib,e}return{}},_.autoExeQueue=function(){return{items:[],enqueue:function(e){this.items.push(e),this.start()},dequeue:function(){return this.items.shift()},getCurrentItem:function(){return this.items[0]},isRun:!1,start:function(){0<this.items.length&&!this.isRun&&(this.isRun=!0,this.getCurrentItem().start())},close:function(){this.dequeue(),this.isRun=!1,this.start()}}},sa.requestQueue=function(e){this.url=e.url},sa.requestQueue.prototype.isEnd=function(){this.received||(this.received=!0,this.close())},sa.requestQueue.prototype.start=function(){var e=this;_.wxrequest({url:this.url,method:"GET",complete:function(){e.isEnd()}})},sa.dataQueue=_.autoExeQueue(),sa.sendStrategy={dataHasSend:!0,dataHasChange:!1,syncStorage:!1,failTime:0,onAppHide:function(){sa.para.batch_send&&this.batchSend()},send:function(e){if(!sa.para.server_url)return!1;if(sa.para.batch_send){if(this.dataHasChange=!0,300<=sa.store.mem.getLength())return logger.info("数据量存储过大，有异常"),!1;sa.store.mem.add(e),sa.store.mem.getLength()<sa.para.batch_send.max_length||this.batchSend()}else this.queueSend(e)},queueSend:function(e){e._flush_time=Date.now(),e=JSON.stringify(e),e=~sa.para.server_url.indexOf("?")?sa.para.server_url+"&data="+encodeURIComponent(_.base64Encode(e)):sa.para.server_url+"?data="+encodeURIComponent(_.base64Encode(e));e=new sa.requestQueue({url:e});e.close=function(){sa.dataQueue.close()},sa.dataQueue.enqueue(e)},wxrequest:function(e){var t;_.isArray(e.data)&&0<e.data.length?(t=Date.now(),e.data.forEach(function(e){e._flush_time=t}),e.data=JSON.stringify(e.data),_.wxrequest({url:sa.para.server_url,method:"POST",dataType:"text",data:"data_list="+encodeURIComponent(_.base64Encode(e.data)),success:function(){e.success(e.len)},fail:function(){e.fail()}})):e.success(e.len)},batchSend:function(){var e,t;!this.dataHasSend||0<(t=(e=sa.store.mem.mdata).length)&&(this.dataHasSend=!1,this.wxrequest({data:e,len:t,success:this.batchRemove.bind(this),fail:this.sendFail.bind(this)}))},sendFail:function(){this.dataHasSend=!0,this.failTime++},batchRemove:function(e){sa.store.mem.clear(e),this.dataHasSend=!0,this.dataHasChange=!0,this.batchWrite(),this.failTime=0},is_first_batch_write:!0,batchWrite:function(){var e=this;this.dataHasChange&&(this.is_first_batch_write&&(this.is_first_batch_write=!1,setTimeout(function(){e.batchSend()},1e3)),this.dataHasChange=!1,this.syncStorage&&sa._.setStorageSync("sensors_mp_prepare_data",sa.store.mem.mdata))},batchInterval:function(){var t=this;!function e(){setTimeout(function(){t.batchWrite(),e()},500)}(),function e(){setTimeout(function(){t.batchSend(),e()},sa.para.batch_send.send_timeout*Math.pow(2,t.failTime))}()}},sa.setOpenid=function(e,t){sa.store.set("openid",e),t?sa.store.set("distinct_id",e):sa.identify(e,!0)},sa.initWithOpenid=function(t,a){(t=t||{}).appid&&(sa.para.appid=t.appid),sa.openid.getOpenid(function(e){e&&sa.setOpenid(e,t.isCoverLogin),a&&_.isFunction(a)&&a(e),sa.init(t)})},_.each(["setProfile","setOnceProfile","track","quick","incrementProfile","appendProfile","login","logout","registerApp","register","clearAllRegister","clearAllProps","clearAppRegister"],function(e){var t=sa[e];sa[e]=function(){sa.initialState.isComplete?t.apply(sa,arguments):sa.initialState.queue.push([e,arguments])}}),_.setQuery=function(e,a){if(e&&_.isObject(e)&&!_.isEmptyObject(e)){var r=[];return _.each(e,function(e,t){"q"===t&&_.isString(e)&&!e.indexOf("http")||r.push(a?t+"="+e:t+"="+_.decodeURIComponent(e))}),r.join("&")}return""},_.getUtmFromPage=function(){var e={};try{var t,a=getCurrentPages(),r=JSON.parse(JSON.stringify(a[a.length-1].options));for(t in r)r[t]=_.decodeURIComponent(r[t]);e=_.getCustomUtmFromQuery(r,"$","_","$")}catch(e){logger.info(e)}return e},sa.autoTrackCustom={trackCustom:function(e,t,a){var r,s=sa.para.autoTrack[e];sa.para.autoTrack&&s&&("function"==typeof s?(r=s(),_.isObject(r)&&_.extend(t,r)):_.isObject(s)&&(_.extend(t,s),sa.para.autoTrack[e]=!0),sa.track(a,t))},appLaunch:function(e,t){"object"!=typeof this||this.trackCustom||(this[sa.para.name]=sa);var a={};e&&e.scene?(current_scene=e.scene,a.$scene=_.getMPScene(e.scene)):a.$scene="未取到值",e&&e.scene&&1010===e.scene&&e.query&&e.query.sampshare&&delete e.query.sampshare,e&&e.path&&(a.$url_path=_.getPath(e.path),!0===sa.para.preset_properties.url_path&&sa.registerApp({$url_path:a.$url_path})),_.setShareInfo(e,a);var r=_.setUtm(e,a);is_first_launch?(a.$is_first_time=!0,_.isEmptyObject(r.pre1)||sa.setOnceProfile(r.pre1)):a.$is_first_time=!1,_.setLatestChannel(r.pre2),_.setSfSource(e,a),sa.registerApp({$latest_scene:a.$scene}),a.$url_query=_.setQuery(e.query),t?(a=_.extend(a,t),sa.track("$MPLaunch",a)):sa.para.autoTrack&&sa.para.autoTrack.appLaunch&&sa.autoTrackCustom.trackCustom("appLaunch",a,"$MPLaunch")},appShow:function(e,t){var a={};mpshow_time=(new Date).getTime(),e&&e.scene?(current_scene=e.scene,a.$scene=_.getMPScene(e.scene)):a.$scene="未取到值",e&&e.scene&&1010===e.scene&&e.query&&e.query.sampshare&&delete e.query.sampshare,e&&e.path&&(a.$url_path=_.getPath(e.path),!0===sa.para.preset_properties.url_path&&sa.registerApp({$url_path:a.$url_path})),!_.isObject(sa.para.preset_properties.location)||"wgs84"!==sa.para.preset_properties.location.type&&"gcj02"!==sa.para.preset_properties.location.type||sa.getLocation(),_.setShareInfo(e,a);var r=_.setUtm(e,a);_.setLatestChannel(r.pre2),_.setSfSource(e,a),sa.registerApp({$latest_scene:a.$scene}),a.$url_query=_.setQuery(e.query),t?(a=_.extend(a,t),sa.track("$MPShow",a)):sa.para.autoTrack&&sa.para.autoTrack.appShow&&sa.autoTrackCustom.trackCustom("appShow",a,"$MPShow")},appHide:function(e){var t=(new Date).getTime(),a={};a.$url_path=_.getCurrentPath(),mpshow_time&&0<t-mpshow_time&&(t-mpshow_time)/36e5<24&&(a.event_duration=(t-mpshow_time)/1e3),e?(a=_.extend(a,e),sa.track("$MPHide",a)):sa.para.autoTrack&&sa.para.autoTrack.appHide&&sa.autoTrackCustom.trackCustom("appHide",a,"$MPHide"),sa.sendStrategy.onAppHide()},pageLoad:function(e){current_scene&&1010===current_scene&&e&&e.sampshare&&delete e.sampshare,e&&_.isObject(e)&&(this.sensors_mp_url_query=_.setQuery(e),this.sensors_mp_encode_url_query=_.setQuery(e,!0))},pageShow:function(){var e={},t=_.getCurrentPath(),a=_.getPageTitle(t);e.$referrer=sa_referrer,e.$url_path=t,sa.status.last_referrer=sa_referrer,e.$url_query=this.sensors_mp_url_query||"",e=_.extend(e,_.getUtmFromPage()),_.setPageSfSource(e),a&&(e.$title=a),sa.para.onshow?sa.para.onshow(sa,t,this):_.isObject(sa.para.autotrack_exclude_page)&&_.isArray(sa.para.autotrack_exclude_page.pageShow)&&~sa.para.autotrack_exclude_page.pageShow.indexOf(t)||sa.autoTrackCustom.trackCustom("pageShow",e,"$MPViewScreen"),!0===sa.para.preset_properties.url_path&&sa.registerApp({$url_path:t}),sa_referrer=t,sa.status.referrer=t},pageShare:function(e){var t=e.onShareAppMessage;e.onShareAppMessage=function(){share_method="转发消息卡片";var e=t.apply(this,arguments);return sa.para.autoTrack&&sa.para.autoTrack.pageShare&&sa.autoTrackCustom.trackCustom("pageShare",{$url_path:_.getCurrentPath(),$share_depth:query_share_depth,$share_method:share_method},"$MPShare"),sa.para.allow_amend_share_path&&("object"!=typeof e&&((e={}).path=_.getCurrentUrl(this)),"object"!=typeof e||void 0!==e.path&&""!==e.path||(e.path=_.getCurrentUrl(this)),"object"==typeof e&&"string"==typeof e.path&&(~e.path.indexOf("?")?"&"!==e.path.slice(-1)&&(e.path=e.path+"&"):e.path=e.path+"?"),e.path=e.path+"sampshare="+encodeURIComponent(_.getShareInfo())),e}},pageShareTimeline:function(e){var t=e.onShareTimeline;e.onShareTimeline=function(){share_method="朋友圈分享";var e=t.apply(this,arguments);return sa.para.autoTrack&&sa.para.autoTrack.pageShare&&sa.autoTrackCustom.trackCustom("pageShare",{$url_path:_.getCurrentPath(),$share_depth:query_share_depth,$share_method:share_method},"$MPShare"),sa.para.allow_amend_share_path&&("object"==typeof(e="object"!=typeof e?{}:e)&&void 0===e.query&&(e.query=""),"object"==typeof e&&"string"==typeof e.query&&""!==e.query&&"&"!==e.query.slice(-1)&&(e.query=e.query+"&"),e.query=e.query+"sampshare="+encodeURIComponent(_.getShareInfo())),e}},pageAddFavorites:function(){var e={};e.$url_path=_.getCurrentPath(),sa.para.autoTrack&&sa.para.autoTrack.mpFavorite&&sa.autoTrackCustom.trackCustom("mpFavorite",e,"$MPAddFavorites")}},sa.quick=function(){var e=arguments[0],t=arguments[1],a=arguments[2],a=_.isObject(a)?a:{};if("getAnonymousID"===e){if(!_.isEmptyObject(sa.store._state))return sa.store._state._first_id||sa.store._state.first_id||sa.store._state._distinct_id||sa.store._state.distinct_id;logger.info("请先初始化SDK")}else"appLaunch"===e||"appShow"===e?t?sa.autoTrackCustom[e](t,a):logger.info("App的launch和show，在sensors.quick第二个参数必须传入App的options参数"):"appHide"===e&&(a=_.isObject(t)?t:{},sa.autoTrackCustom[e](a))},sa.appLaunch=function(e,t){var a={};_.isObject(t)&&(a=_.extend(a,t)),e&&e.scene?(current_scene=e.scene,a.$scene=_.getMPScene(e.scene)):a.$scene="未取到值",e&&e.scene&&1010===e.scene&&e.query&&e.query.sampshare&&delete e.query.sampshare,e&&e.path&&(a.$url_path=_.getPath(e.path),!0===sa.para.preset_properties.url_path&&sa.registerApp({$url_path:a.$url_path})),_.setShareInfo(e,a);t=_.setUtm(e,a);is_first_launch?(a.$is_first_time=!0,_.isEmptyObject(t.pre1)||sa.setOnceProfile(t.pre1)):a.$is_first_time=!1,_.setLatestChannel(t.pre2),_.setSfSource(e,a),sa.registerApp({$latest_scene:a.$scene}),a.$url_query=_.setQuery(e.query),sa.track("$MPLaunch",a)},sa.appShow=function(e,t){var a={};_.isObject(t)&&(a=_.extend(a,t)),mpshow_time=(new Date).getTime(),e&&e.scene?(current_scene=e.scene,a.$scene=_.getMPScene(e.scene)):a.$scene="未取到值",e&&e.scene&&1010===e.scene&&e.query&&e.query.sampshare&&delete e.query.sampshare,e&&e.path&&(a.$url_path=_.getPath(e.path),!0===sa.para.preset_properties.url_path&&sa.registerApp({$url_path:a.$url_path})),!_.isObject(sa.para.preset_properties.location)||"wgs84"!==sa.para.preset_properties.location.type&&"gcj02"!==sa.para.preset_properties.location.type||sa.getLocation(),_.setShareInfo(e,a);t=_.setUtm(e,a);_.setLatestChannel(t.pre2),_.setSfSource(e,a),sa.registerApp({$latest_scene:a.$scene}),a.$url_query=_.setQuery(e.query),sa.track("$MPShow",a)},sa.appHide=function(e){var t=(new Date).getTime(),a={};(a=_.isObject(e)?_.extend(a,e):a).$url_path=_.getCurrentPath(),mpshow_time&&0<t-mpshow_time&&(t-mpshow_time)/36e5<24&&(a.event_duration=(t-mpshow_time)/1e3),sa.track("$MPHide",a),sa.sendStrategy.onAppHide()},sa.pageShow=function(e){var t={},a=_.getCurrentPath(),r=_.getPageTitle(a);_.isObject(e)&&(t=_.extend(t,e));e={};try{var s=getCurrentPages(),e=s[s.length-1]}catch(e){logger.info(e)}!0===sa.para.preset_properties.url_path&&sa.registerApp({$url_path:a}),r&&(t.$title=r),t.$referrer=sa_referrer,t.$url_path=a,sa.status.last_referrer=sa_referrer,t.$url_query=e.sensors_mp_url_query||"",t=_.extend(t,_.getUtmFromPage()),_.setPageSfSource(t),sa.track("$MPViewScreen",t),sa_referrer=a,sa.status.referrer=a};var oldApp=App;App=function(e){e[sa.para.name]=sa,oldApp.apply(this,arguments)},wx.onAppShow(function(e){var t;sa.para.launched||(t=wx.getLaunchOptionsSync()||{},sa.autoTrackCustom.appLaunch(t),sa.para.launched=!0),sa.autoTrackCustom.appShow(e)}),wx.onAppHide(function(){sa.autoTrackCustom.appHide()});var oldPage=Page;Page=function(e){var t=sa.para.autoTrack&&sa.para.autoTrack.mpClick&&_.getMethods(e);if(t)for(var a=0,r=t.length;a<r;a++)click_proxy(e,t[a]);sa.para.autoTrack&&sa.para.autoTrack.mpClick&&tabProxy(e),mp_proxy(e,"onLoad","pageLoad"),mp_proxy(e,"onShow","pageShow"),mp_proxy(e,"onAddToFavorites","pageAddFavorites"),"function"==typeof e.onShareAppMessage&&sa.autoTrackCustom.pageShare(e),"function"==typeof e.onShareTimeline&&sa.autoTrackCustom.pageShareTimeline(e),oldPage.apply(this,arguments)};var oldComponent=Component;Component=function(e){try{var t=sa.para.autoTrack&&sa.para.autoTrack.mpClick&&_.getMethods(e.methods);if(t)for(var a=0,r=t.length;a<r;a++)click_proxy(e.methods,t[a]);sa.para.autoTrack&&sa.para.autoTrack.mpClick&&tabProxy(e.methods),mp_proxy(e.methods,"onLoad","pageLoad"),mp_proxy(e.methods,"onShow","pageShow"),mp_proxy(e.methods,"onAddToFavorites","pageAddFavorites"),"function"==typeof e.methods.onShareAppMessage&&sa.autoTrackCustom.pageShare(e.methods),"function"==typeof e.methods.onShareTimeline&&sa.autoTrackCustom.pageShareTimeline(e.methods),oldComponent.apply(this,arguments)}catch(e){oldComponent.apply(this,arguments)}},sa.initial(),module.exports=sa;
